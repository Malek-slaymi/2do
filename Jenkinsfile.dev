pipeline {
  agent any
  environment {
    IMAGE_NAME = "react-dev-build:${env.BUILD_NUMBER}"
    CONTAINER_NAME = "dev_test_${env.BUILD_NUMBER}"
    APP_PORT = "3000"
  }

  stages {
    stage('Checkout') { steps { checkout scm } }

    stage('Install') {
      steps {
        script { if (isUnix()) { sh 'npm ci' } else { bat 'npm ci' } }
      }
    }

    stage('Unit Tests') {
      steps {
        script {
          if (isUnix()) {
            sh 'npm test -- --watchAll=false || true' // don't fail pipeline for flaky tests unless you want
          } else {
            bat 'npm test -- --watchAll=false || exit 0'
          }
        }
      }
    }

    stage('Build') {
      steps { script { if (isUnix()) { sh 'npm run build' } else { bat 'npm run build' } } }
    }

    stage('Docker Build') {
      steps { script { if (isUnix()) { sh "docker build -t ${IMAGE_NAME} ." } else { bat "docker build -t ${IMAGE_NAME} ." } } }
    }

    stage('Run Container') {
      steps { script { if (isUnix()) { sh "docker run -d --name ${CONTAINER_NAME} -p ${APP_PORT}:80 ${IMAGE_NAME}" } else { bat "docker run -d --name ${CONTAINER_NAME} -p ${APP_PORT}:80 ${IMAGE_NAME}" } } }
    }

    stage('Smoke Test') {
      steps {
        script {
          def host = "http://localhost:${env.APP_PORT}"
          def maxRetries = 30
          def ok = false
          for (int i=0; i<maxRetries; i++) {
            try {
              if (isUnix()) {
                def code = sh(script: "curl -s -o /dev/null -w '%{http_code}' ${host}", returnStdout: true).trim()
                if (code == '200') { ok = true; break }
              } else {
                def ps = bat(returnStdout: true, script: "powershell -Command \"(Invoke-WebRequest -UseBasicParsing -Uri '${host}').StatusCode\"").trim()
                if (ps == '200') { ok = true; break }
              }
            } catch (err) { echo "Waiting for app... (${i+1}/${maxRetries})" }
            sleep 2
          }
          if (!ok) { error("Smoke test failed for ${host}") } else { echo "Smoke OK" }
        }
      }
    }

    stage('Archive') {
      steps { archiveArtifacts artifacts: 'dist/**', fingerprint: true }
    }
  }

  post {
    always {
      script {
        if (isUnix()) {
          sh "docker rm -f ${CONTAINER_NAME} || true"
        } else {
          bat "docker rm -f ${CONTAINER_NAME} || echo not present"
        }
      }
    }
  }
}

