pipeline {
  agent any

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Install') {
      steps { bat "npm ci" }
    }

    stage('Unit Tests') {
      steps { bat "npm test -- --watchAll=false" }
    }

    stage('Build') {
      steps { bat "npm run build" }
    }

    stage('Docker Build') {
      steps { bat "docker build -t react-dev-build ." }
    }

    stage('Run Container') {
      steps { bat "docker run -d --name dev_test -p 3000:80 react-dev-build" }
    }

    stage('Smoke Test') {
      steps { bat "./smoke.sh http://localhost:3000" }
    }

    stage('Archive') {
      steps {
        archiveArtifacts artifacts: "build/**"
      }
    }
  }

  post {
    always { bat "docker rm -f dev_test || true" }
  }
}
