pipeline {
    agent none
    stages {
        stage('Parallel Builds') {
            parallel {
                stage('Node 16') {
                    agent { label 'node-16' }
                    stages {
                        stage('Checkout') {
                            steps { checkout scm }
                        }
                        stage('Setup') {
                            steps { bat 'npm install' }
                        }
                        stage('Build') {
                            steps { bat 'npm run build' }
                        }
                        stage('Run') {
                            steps { bat 'npm start &' }
                        }
                        stage('Smoke Test') {
                            steps {
                                script {
                                    def result = sh(script: 'curl -s -o /dev/null -w "%{http_code}" http://localhost:3000', returnStdout: true).trim()
                                    if (result != '200') {
                                        error("Smoke Test Failed! Status: ${result}")
                                    }
                                    echo "Smoke Test Passed!"
                                }
                            }
                        }
                        stage('Archive Artifacts') {
                            steps { archiveArtifacts artifacts: 'build/**', fingerprint: true }
                        }
                        stage('Cleanup') {
                            steps { bat 'kill $(lsof -t -i:3000) || true' }
                        }
                    }
                }
                stage('Node 18') {
                    agent { label 'node-18' }
                    stages {
                        stage('Checkout') { steps { checkout scm } }
                        stage('Setup') { steps { bat 'npm install' } }
                        stage('Build') { steps { bat 'npm run build' } }
                        stage('Run') { steps { bat 'npm start &' } }
                        stage('Smoke Test') {
                            steps {
                                script {
                                    def result = sh(script: 'curl -s -o /dev/null -w "%{http_code}" http://localhost:3000', returnStdout: true).trim()
                                    if (result != '200') { error("Smoke Test Failed! Status: ${result}") }
                                    echo "Smoke Test Passed!"
                                }
                            }
                        }
                        stage('Archive Artifacts') { steps { archiveArtifacts artifacts: 'build/**', fingerprint: true } }
                        stage('Cleanup') { steps { bat 'kill $(lsof -t -i:3000) || true' } }
                    }
                }
            }
        }
    }
}
